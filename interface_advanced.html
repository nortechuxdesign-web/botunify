<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Trading Bot Avançado - BTC/USDT (Binance)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0e1116; --panel:#121621; --muted:#9aa4bf; --text:#e6e9f0; --accent:#5b8def; --buy:#00c389; --sell:#ff5c7a; --warn:#f0b90b; --ok:#13d38e; --bad:#ff5c7a; }
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial; background:linear-gradient(180deg,#0b0f16,#0e1116); color:var(--text)}
    header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:#0b0f16;border-bottom:1px solid #1c2233;position:sticky;top:0;z-index:10}
    header .brand{font-weight:700;font-size:18px;display:flex;gap:10px;align-items:center}
    header .brand small{color:var(--muted);font-weight:400;margin-left:8px}
    .badge{padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700;display:inline-block;border:1px solid #2a3658;background:#182035;color:#cdd6f4}
    .badge.ok{background:rgba(19,211,142,.12);border:1px solid rgba(19,211,142,.4);color:#6ef2c8}
    .badge.bad{background:rgba(255,92,122,.12);border:1px solid rgba(255,92,122,.4);color:#ffb7c3}
    .grid{display:grid;grid-template-columns:1.5fr 1fr;gap:16px;padding:16px}
    .panel{background:var(--panel);border:1px solid #1c2233;border-radius:12px;padding:12px 12px 8px 12px;box-shadow:0 10px 20px rgba(0,0,0,.25)}
    .panel h3{margin:6px 0 12px 0;font-size:14px;color:var(--muted);letter-spacing:.4px;text-transform:uppercase}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{background:#182035;color:#cdd6f4;border:1px solid #2a3658;border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:600}
    .btn:hover{background:#1d2743}.btn.buy{background:rgba(0,195,137,.1);border-color:rgba(0,195,137,.35);color:#7cf1d6}
    .btn.sell{background:rgba(255,92,122,.1);border-color:rgba(255,92,122,.35);color:#ffa0b0}
    .btn.accent{background:rgba(91,141,239,.12);border-color:rgba(91,141,239,.45);color:#9ab8ff}
    .btn.warn{background:rgba(240,185,11,.12);border-color:rgba(240,185,11,.45);color:#f8d765}
    .stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .stat{background:#0f1422;border:1px solid #1c2233;border-radius:10px;padding:10px}
    .stat .label{color:var(--muted);font-size:12px}.stat .val{font-size:18px;font-weight:700;margin-top:6px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .list{font-size:13px;color:#c9d4f4;line-height:1.4}.list div{margin-bottom:6px}
    .subtle{color:var(--muted)} .chart-wrap{height:480px}
    .form{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    input,select{background:#0f1422;color:#dbe4ff;border:1px solid #1c2233;border-radius:8px;padding:8px 10px;outline:none}
    .footer{text-align:center;color:var(--muted);font-size:12px;padding:14px 0 24px}
    @media (max-width:1100px){.grid{grid-template-columns:1fr}.chart-wrap{height:400px}}
  </style>
  <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
<header>
  <div class="brand">
    <span>Trading Bot Avançado</span>
    <small id="marketLabel">BTC/USDT (Binance)</small>
    <span id="providerBadge" class="badge">Fonte</span>
  </div>
  <div class="row">
    <button class="btn accent" onclick="startBot()">Iniciar</button>
    <button class="btn" onclick="stopBot()">Parar</button>
    <button class="btn warn" onclick="resetBot()">Reset</button>
  </div>
</header>

<main class="grid">
  <section class="panel">
    <h3>Gráfico - Candles (BTC/USDT)</h3>
    <div id="chart" class="chart-wrap"></div>
  </section>

  <aside class="panel">
    <h3>Status & Controles</h3>
    <div class="stat-grid">
      <div class="stat">
        <div class="label">Preço</div>
        <div class="val" id="price">-</div>
        <div class="subtle" id="lastUpdate">—</div>
      </div>
      <div class="stat">
        <div class="label">Sinal</div>
        <div class="val" id="signal">HOLD</div>
        <span id="filterBadge" class="badge">Filtros</span>
      </div>
      <div class="stat">
        <div class="label">Capital</div>
        <div class="val" id="capital">$0.00</div>
        <div class="subtle">P&L: <span id="totalPnl">$0.00</span></div>
      </div>
      <div class="stat">
        <div class="label">Posição</div>
        <div class="val" id="position">Flat</div>
        <div class="subtle">Trades: <span id="tradesToday">0</span></div>
      </div>
    </div>

    <div style="height:10px"></div>
    <div class="grid-2">
      <div class="panel" style="padding:10px">
        <div class="label">Confirmação MTF</div>
        <div class="list">
          <div>Long: <b id="mtfLong">0.00</b></div>
          <div>Short: <b id="mtfShort">0.00</b></div>
        </div>
      </div>
      <div class="panel" style="padding:10px">
        <div class="label">ML</div>
        <div class="list">
          <div>Status: <span id="mlStatus">—</span></div>
          <div>P(up): <b id="mlProb">0.50</b></div>
        </div>
      </div>
    </div>

    <div style="height:10px"></div>
    <div class="panel" style="padding:10px">
      <div class="label">Motivo</div>
      <div id="reason" class="list"></div>
    </div>

    <div style="height:10px"></div>
    <div class="panel" style="padding:10px">
      <div class="label">Ações</div>
      <div class="form">
        <button class="btn accent" onclick="trainML()">Treinar ML (fallback)</button>
        <button class="btn" onclick="backtest()">Backtest</button>
        <select id="objective"><option value="sharpe">Sharpe</option><option value="pnl">P&L</option></select>
        <input id="trials" type="number" value="10" min="5" max="50"/>
        <button class="btn buy" onclick="optimize()">Otimizar</button>
      </div>
      <div id="actionLog" class="subtle"></div>
    </div>
  </aside>

  <section class="panel">
    <h3>Indicadores</h3>
    <div class="grid-2">
      <div class="list">
        <div>RSI: <b id="rsi">-</b></div>
        <div>BB pos: <b id="bbpos">-</b></div>
        <div>EMA: <b id="ema">-</b></div>
        <div>MACD hist: <b id="macdh">-</b></div>
      </div>
      <div class="list">
        <div>Stoch K: <b id="stochk">-</b></div>
        <div>Vol Ratio: <b id="volr">-</b></div>
        <div>ATR: <b id="atr">-</b></div>
        <div>EMA Slope: <b id="emas">-</b></div>
      </div>
    </div>
  </section>

  <section class="panel">
    <h3>Performance</h3>
    <div class="grid-2">
      <div class="list">
        <div>Total trades: <b id="totalTrades">0</b></div>
        <div>Fechados: <b id="closedTrades">0</b></div>
        <div>Win rate: <b id="winRate">0%</b></div>
      </div>
      <div class="list">
        <div>Avg P&L: <b id="avgPnl">$0.00</b></div>
        <div>Best trade: <b id="bestTrade">$0.00</b></div>
        <div>Worst trade: <b id="worstTrade">$0.00</b></div>
      </div>
    </div>
  </section>
</main>

<div class="footer">Dados: Binance (BTC/USDT, 1m). O desempenho passado não garante resultado futuro.</div>

<script>
  let chart, candleSeries, volumeSeries;
  function initChart() {
    chart = LightweightCharts.createChart(document.getElementById('chart'), {
      layout:{background:{type:'solid',color:'#0f1422'},textColor:'#cfd8f6'},
      grid:{vertLines:{color:'#1b2235'},horzLines:{color:'#1b2235'}},
      crosshair:{mode:1}, rightPriceScale:{borderColor:'#1b2235'},
      timeScale:{borderColor:'#1b2235',timeVisible:true,secondsVisible:false}
    });
    candleSeries = chart.addCandlestickSeries({
      upColor:'#00c389', borderUpColor:'#00c389', wickUpColor:'#00c389',
      downColor:'#ff5c7a', borderDownColor:'#ff5c7a', wickDownColor:'#ff5c7a'
    });
    volumeSeries = chart.addHistogramSeries({color:'#3c4f7a', priceFormat:{type:'volume'}, priceScaleId:'', scaleMargins:{top:0.85,bottom:0}});
  }
  function toEpochSec(ts){ return Math.floor(new Date(ts).getTime()/1000); }

  async function loadChart(){
    const res=await fetch('/api/bot/chart'); const data=await res.json();
    const candles=(data.candlesticks||[]).map(d=>({time:toEpochSec(d.timestamp),open:+d.open,high:+d.high,low:+d.low,close:+d.close}));
    const vols=(data.candlesticks||[]).map(d=>({time:toEpochSec(d.timestamp),value:+d.volume,color:(+d.close>=+d.open)?'rgba(0,195,137,.6)':'rgba(255,92,122,.6)'}));
    candleSeries.setData(candles); volumeSeries.setData(vols);
    const markers=(data.trade_points||[]).map(tp=>{
      let shape='circle', pos='aboveBar', color='#b2c7ff', text='';
      if(tp.type==='BUY'){shape='arrowUp';pos='belowBar';color='#00c389';text='BUY'}
      else if(tp.type==='SELL'){shape='arrowDown';pos='aboveBar';color='#ff5c7a';text='SELL'}
      else {shape='circle';pos='aboveBar';color='#f0b90b';text='EXIT'}
      return {time:toEpochSec(tp.timestamp), position:pos, shape, color, text};
    });
    candleSeries.setMarkers(markers);
  }

  async function loadStatus(){
    const res=await fetch('/api/bot/status'); const s=await res.json();
    document.getElementById('marketLabel').textContent=`${s.market} (${s.ticker})`;
    const pb=document.getElementById('providerBadge');
    pb.textContent=`${s.data_source||'Fonte'} ${s.last_fetch_ok?'OK':'OFF'}`; pb.className=`badge ${s.last_fetch_ok?'ok':'bad'}`;
    if(s.current_data && s.current_data.price){
      document.getElementById('price').textContent=`$ ${(+s.current_data.price).toFixed(2)}`;
      document.getElementById('lastUpdate').textContent=new Date(s.current_data.timestamp).toLocaleString();
    }
    document.getElementById('capital').textContent=`$ ${(+s.current_capital||0).toFixed(2)}`;
    document.getElementById('totalPnl').textContent=`$ ${(+s.total_pnl||0).toFixed(2)}`;
    document.getElementById('tradesToday').textContent=s.trades_today||0;
    document.getElementById('position').textContent = s.position===1?'Long':(s.position===-1?'Short':'Flat');

    const sig=s.signal||{};
    document.getElementById('signal').textContent=`${sig.signal||'HOLD'} ${sig.strength? '('+Number(sig.strength).toFixed(0)+')':''}`;
    document.getElementById('reason').textContent=sig.reason||'—';
    const det=sig.details||{};
    document.getElementById('mtfLong').textContent=Number(det.tf_long||0).toFixed(2);
    document.getElementById('mtfShort').textContent=Number(det.tf_short||0).toFixed(2);
    document.getElementById('mlProb').textContent=Number(det.ml_p_up||0.5).toFixed(2);
    const ml=s.ml||{};
    document.getElementById('mlStatus').textContent=ml.enabled?(ml.trained?'Treinado':'Pronto p/ treinar'):'Desativado';
    const fb=document.getElementById('filterBadge');
    if(det.filter_ok){ fb.className='badge ok'; fb.textContent=`Filtros OK x${Number(det.filter_mult||1).toFixed(2)}` }
    else { fb.className='badge bad'; fb.textContent=`Filtros: ${Number(det.filter_mult||1).toFixed(2)}` }

    const ind=s.indicators||{};
    document.getElementById('rsi').textContent=ind.rsi?ind.rsi.toFixed(1):'-';
    document.getElementById('bbpos').textContent=ind.bb_position?ind.bb_position.toFixed(2):'-';
    document.getElementById('ema').textContent=ind.ema?ind.ema.toFixed(2):'-';
    document.getElementById('macdh').textContent=ind.macd_histogram?ind.macd_histogram.toFixed(5):'-';
    document.getElementById('stochk').textContent=ind.stoch_k?ind.stoch_k.toFixed(1):'-';
    document.getElementById('volr').textContent=ind.volume_ratio?ind.volume_ratio.toFixed(2):'-';
    document.getElementById('atr').textContent=ind.atr?ind.atr.toFixed(2):'-';
    document.getElementById('emas').textContent=ind.ema_slope?ind.ema_slope.toFixed(5):'-';

    const p=s.performance||{};
    document.getElementById('totalTrades').textContent=p.total_trades||0;
    document.getElementById('closedTrades').textContent=p.closed_trades||0;
    document.getElementById('winRate').textContent=p.win_rate?(p.win_rate.toFixed(1)+'%'):'0%';
    document.getElementById('avgPnl').textContent=`$ ${Number(p.avg_pnl||0).toFixed(2)}`;
    document.getElementById('bestTrade').textContent=`$ ${Number(p.best_trade||0).toFixed(2)}`;
    document.getElementById('worstTrade').textContent=`$ ${Number(p.worst_trade||0).toFixed(2)}`;
  }

  async function startBot(){ const r=await fetch('/api/bot/start',{method:'POST'}); const j=await r.json(); logAction(j.success?'Bot iniciado':'Bot já estava em execução'); }
  async function stopBot(){ const r=await fetch('/api/bot/stop',{method:'POST'}); const j=await r.json(); logAction(j.success?'Bot parado':'Bot já estava parado'); }
  async function resetBot(){ await fetch('/api/bot/reset',{method:'POST'}); logAction('Reset concluído'); setTimeout(()=>{loadStatus();loadChart()},800); }
  async function trainML(){
    logAction('Treinando ML (fallback automático)...');
    const r=await fetch('/api/bot/train_ml',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({period:'7d',interval:'1m'})});
    const j=await r.json();
    if(j.success){
      const rep=j.report||{};
      logAction(`ML OK | Período: ${rep.period}, Horizon: ${rep.horizon}, TFs: [${(rep.timeframes_used||[]).join(',')}], ACC: ${rep.acc_mean??'-'}, AUC: ${rep.auc_mean??'-'}, N=${rep.n_samples??'-'}`);
    }else{
      logAction(`Falha ML: ${j.error||''}`);
    }
    loadStatus();
  }
  async function backtest(){
    logAction('Backtest...');
    const r=await fetch('/api/bot/backtest',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({period:'7d',interval:'1m',walkforward:false})});
    const j=await r.json();
    if(j.success){
      logAction(`Backtest OK | Final: $${Number(j.final_capital||0).toFixed(2)} | PnL: $${Number(j.total_pnl||0).toFixed(2)} | Sharpe: ${Number(j.sharpe||0).toFixed(2)} | MaxDD: ${(Number(j.max_drawdown||0)*100).toFixed(1)}%`);
    }else{ logAction(`Backtest falhou: ${j.error||''}`) }
    loadStatus();
  }
  async function optimize(){
    const trials=Number(document.getElementById('trials').value||10);
    const objective=document.getElementById('objective').value;
    logAction(`Otimizando (${objective})...`);
    const r=await fetch('/api/bot/optimize',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({period:'7d',interval:'1m',trials,objective})});
    const j=await r.json();
    logAction(j.success?`Melhores params aplicados | candidatos: ${j.count}`:`Otimização falhou: ${j.error||''}`);
    loadStatus();
  }
  function logAction(msg){ document.getElementById('actionLog').textContent=`[${new Date().toLocaleTimeString()}] ${msg}`; }

  initChart(); loadChart(); loadStatus();
  setInterval(loadChart, 5000); setInterval(loadStatus, 5000);
</script>
</body>
</html>
